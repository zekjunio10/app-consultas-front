<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta Grátis • Consultas Brasil</title>
  <meta name="description" content="Verifique placa ou chassi gratuitamente — dados mascarados. Baixe PDF e confira a confiabilidade do serviço." />

  <!-- Tailwind CDN (prod) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small custom styles */
    .glass { background: linear-gradient(135deg, rgba(255,255,255,0.85), rgba(255,255,255,0.72)); backdrop-filter: blur(6px); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "SF Pro Text", monospace; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .toast { position: fixed; right: 20px; bottom: 20px; background:#111; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; transition:opacity .2s; z-index:9999; }

    /* Button used for "ver consulta completa" */
    .show-full-btn {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      background: linear-gradient(90deg,#0ea5e9,#6366f1);
      color: white;
      font-weight: 600;
      text-decoration: none;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <header class="max-w-6xl mx-auto px-6 py-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-blue-600 to-cyan-400 flex items-center justify-center text-white font-bold">CB</div>
      <div>
        <h1 class="text-xl font-semibold">Consultas Brasil</h1>
        <p class="text-xs text-slate-500 -mt-1">Confiança em dados veiculares — experimente grátis</p>
      </div>
    </div>
    <nav class="hidden md:flex gap-6 items-center text-sm text-slate-600">
      <a href="#how" class="hover:underline">Como funciona</a>
      <a href="#features" class="hover:underline">Recursos</a>
      <a href="#cta" class="btn-primary">Assinar</a>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-10 grid grid-cols-1 lg:grid-cols-2 gap-10 items-start">

    <!-- HERO / FORM -->
    <section class="glass p-6 rounded-2xl shadow-lg">
      <h2 class="text-2xl md:text-3xl font-extrabold leading-tight">Teste grátis — consulta por <span class="text-blue-600">placa</span> ou <span class="text-blue-600">chassi</span></h2>
      <p class="mt-2 text-sm text-slate-600">Receba um resultado real, com dados mascarados. Baixe o PDF e comprove. Para liberar o resto, faça seu cadastro.</p>

      <form id="leadForm" class="mt-6 grid gap-3" onsubmit="return false;">
        <div class="grid sm:grid-cols-2 gap-3">
          <input id="nome" name="nome" type="text" placeholder="Seu nome" required class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-300" />
          <input id="email" name="email" type="email" placeholder="seu@exemplo.com" required class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-300" />
        </div>

        <div class="grid sm:grid-cols-2 gap-3">
          <input id="whatsapp" name="whatsapp" type="tel" placeholder="(99) 9 9999-9999" inputmode="tel" required class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-300" />

          <select id="tipo" name="tipo" class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-300">
            <option value="veiculos-dados">Placa — Dados do veículo</option>
            <option value="agregados-chassi">Chassi — Agregados</option>
          </select>
        </div>

        <div>
          <label id="labelCampo" for="campo" class="block text-sm text-slate-600 mb-2">Placa</label>
          <input id="campo" name="campo" type="text" placeholder="Ex: ABC1D23 ou 9BWZZZ32ZGP246344" required class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-300" />
        </div>

        <div class="flex items-center gap-3 mt-2">
          <button id="submitBtn" type="button" class="bg-gradient-to-r from-blue-600 to-cyan-500 text-white px-5 py-3 rounded-lg font-semibold shadow hover:brightness-105">Consultar Grátis</button>
          <button id="clearBtn" type="button" class="px-4 py-3 rounded-lg border border-slate-200 text-sm">Limpar</button>
        </div>

        <p class="text-xs text-slate-500 mt-2">Limite: 1 consulta grátis por dia por contato. Dados sensíveis são mascarados.</p>
      </form>

      <div id="loading" class="mt-4 hidden">
        <div class="flex items-center gap-3">
          <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
          <span class="text-sm text-slate-600">Consultando — isso é rápido</span>
        </div>
      </div>

      <div id="resultado" class="mt-6 hidden rounded-lg p-4 bg-white border border-slate-100">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-lg font-semibold">Resultado (mascarado)</h3>
            <p class="text-xs text-slate-500">Os dados sensíveis foram ocultados. cadastre-se para ter acesso ao dados completos</p>
          </div>
          
        </div>

        

        <div id="actionsRow" class="mt-4 flex gap-3 items-center hidden">
          <button id="btn-download" class="px-4 py-2 rounded bg-blue-600 text-white text-sm">Baixar PDF</button>
          <button id="btn-view" class="px-4 py-2 rounded border text-sm">Visualizar PDF</button>
          <button id="btn-email" class="px-4 py-2 rounded bg-amber-500 text-white text-sm">Receber por Email</button>
          <div class="ml-auto flex gap-2 items-center">
            <button id="btn-copy-download" class="px-3 py-2 rounded border text-sm">Copiar link</button>
            <button id="btn-share-whatsapp" class="px-3 py-2 rounded bg-green-600 text-white text-sm">Compartilhar</button>
          </div>
        </div>

        <!-- Resultado text (será truncado visualmente se > 25 linhas) -->
        <pre id="jsonOutput" class="mt-3 bg-slate-50 border border-slate-100 p-3 rounded text-sm mono"></pre>

        <!-- Container para o botão "ver consulta completa" -->
        <div id="showFullBtnContainer" class="mt-3"></div>

      </div>

    </section>

    <!-- RIGHT: BENEFITS + CTA -->
    <aside class="p-6 rounded-2xl">
      <div class="bg-white p-6 rounded-2xl shadow">
        <h3 class="text-lg font-bold">Por que testar?</h3>
        <ul id="features" class="mt-3 space-y-3 text-sm text-slate-600">
          <li>✅ Resultado real — com dados mascarados</li>
          <li>✅ PDF pronto para conferência</li>
          <li>✅ Sem compromisso — sem cartão</li>
          <li>✅ Segurança: salvamos apenas dados mascarados</li>
        </ul>

        <div class="mt-6">
          <h4 class="text-sm font-semibold">Oferta</h4>
          <p class="mt-2 text-slate-600 text-sm">Experimente o sistema gratuitamente.  Cadastre-se para liberar os dados completos.</p>
          <a id="ctaTop" href="#" class="mt-4 inline-block w-full text-center bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold">Assinar e desbloquear</a>
        </div>
      </div>

      <div class="mt-6 text-sm text-slate-500">
        <h4 class="font-semibold">Dicas</h4>
        <ol class="list-decimal ml-5 mt-2 space-y-1">
          <li>Use a placa completa sem espaços.</li>
          <li>Para chassi, envie o VIN completo (17 caracteres) quando possível.</li>
          <li>Se algo falhar, tente novamente ou entre em contato.</li>
        </ol>
      </div>
    </aside>

  </main>

  <footer class="max-w-6xl mx-auto px-6 py-8 text-sm text-slate-500">
    <div class="flex items-center justify-between">
      <div>© Consultas Brasil</div>
      <div>Contato: suporte@consultasbrasil.zya.me</div>
    </div>
  </footer>

  <!-- Modal simples de cadastro (exibir ao desbloquear) -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
      <h3 class="text-lg font-semibold">Criar conta</h3>
      <p class="text-sm text-slate-600 mt-1">Crie sua conta para ver o relatório completo e receber ofertas.</p>
      <div class="mt-4 grid gap-3">
        <input id="signupEmail" placeholder="E-mail" class="px-4 py-3 rounded border" />
        <input id="signupPass" placeholder="Senha" type="password" class="px-4 py-3 rounded border" />
        <div class="flex gap-3">
          <button onclick="submitSignup()" class="px-4 py-2 rounded bg-blue-600 text-white">Criar conta</button>
          <button onclick="closeModal()" class="px-4 py-2 rounded border">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Config ---------- */
    const API_ENDPOINT = 'https://consultasbrasil.zya.me/api/routes/consultas/consulta_gratis.php';

    /* ---------- Helpers UI ---------- */
    function toast(msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerText = msg;
      document.body.appendChild(t);
      requestAnimationFrame(() => t.style.opacity = '1');
      setTimeout(() => { t.style.opacity = '0'; setTimeout(()=>t.remove(), 300); }, 3000);
    }

    function filenameFromContentDisposition(header) {
      if (!header) return null;
      const match = /filename\\*?=(?:UTF-8'')?["']?([^"';]+)["']?/i.exec(header);
      return match ? decodeURIComponent(match[1]) : null;
    }

    function downloadBlob(blob, filename = 'consulta.pdf') {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    function openBlobInNewTab(blob) {
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    function formatJsonHuman(obj, indent = 0) {
      const spacing = '  '.repeat(indent);
      if (obj === null) return spacing + 'null';
      if (typeof obj !== 'object') return spacing + String(obj);
      if (Array.isArray(obj)) {
        if (!obj.length) return spacing + '[]';
        return obj.map((item, i) => spacing + `- Item ${i+1}:\n` + formatJsonHuman(item, indent+1)).join('\n');
      }
      return Object.entries(obj)
        .map(([k,v]) => typeof v === 'object' ? `${spacing}${k}:\n${formatJsonHuman(v, indent+1)}` : `${spacing}${k}: ${v}`)
        .join('\n');
    }

    /* ---------- Elements ---------- */
    const tipoEl = document.getElementById('tipo');
    const labelCampo = document.getElementById('labelCampo');
    const campoEl = document.getElementById('campo');
    const loadingEl = document.getElementById('loading');
    const resultadoEl = document.getElementById('resultado');
    const jsonOutput = document.getElementById('jsonOutput');
    const showFullBtnContainer = document.getElementById('showFullBtnContainer');

    const btnDownload = document.getElementById('btn-download');
    const btnView = document.getElementById('btn-view');
    const btnEmail = document.getElementById('btn-email');
    const btnCopyDownload = document.getElementById('btn-copy-download');
    const btnShareWhatsapp = document.getElementById('btn-share-whatsapp');
    const actionsRow = document.getElementById('actionsRow');

    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');

    /* ---------- UI behavior ---------- */
    tipoEl.addEventListener('change', () => {
      labelCampo.textContent = tipoEl.value === 'veiculos-dados' ? 'Placa' : 'Chassi';
      campoEl.value = '';
      campoEl.placeholder = tipoEl.value === 'veiculos-dados' ? 'Ex: ABC1D23' : 'Ex: 9BWZZZ32ZGP246344';
    });

    // Mask whatsapp
    const whatsappEl = document.getElementById('whatsapp');
    whatsappEl.addEventListener('input', () => {
      let v = whatsappEl.value.replace(/\D/g,'');
      if (v.length > 11) v = v.slice(0,11);
      if (v.length <= 10) whatsappEl.value = v.replace(/(\d{2})(\d{4})(\d{0,4})/,'($1) $2-$3').trim();
      else whatsappEl.value = v.replace(/(\d{2})(\d{5})(\d{0,4})/,'($1) $2-$3').trim();
    });

    function validateForm(data) {
        if (!data.nome || data.nome.trim().length < 2) return 'Nome inválido';
        if (!data.email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(data.email)) return 'E-mail inválido';
        if (!data.whatsapp || data.whatsapp.replace(/\D/g,'').length < 10) return 'Whatsapp inválido';
        if (data.tipo === 'veiculos-dados' && (!data.placa || data.placa.trim().length < 5)) return 'Placa inválida';
        if (data.tipo === 'agregados-chassi' && (!data.chassi || data.chassi.trim().length < 8)) return 'Chassi inválido';
        return null;
    }

    function resetForm() {
      document.getElementById('leadForm').reset();
      resultadoEl.classList.add('hidden');
      jsonOutput.textContent = '';
      actionsRow.classList.add('hidden');
      showFullBtnContainer.innerHTML = '';
      jsonOutput.removeAttribute('data-full');
    }

    clearBtn.addEventListener('click', resetForm);

    /* ---------- Truncation logic (25 linhas) ---------- */
    const MAX_LINES = 25;
    function updateTruncation() {
      showFullBtnContainer.innerHTML = ''; // clear previous
      const full = jsonOutput.getAttribute('data-full') || jsonOutput.textContent || '';
      const normalized = String(full).replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      const lines = normalized.split('\n');
      if (lines.length > MAX_LINES) {
        const visible = lines.slice(0, MAX_LINES).join('\n');
        jsonOutput.textContent = visible + '\n\n...';
        // create button
        const a = document.createElement('a');
        a.href = '/register.html';
        a.className = 'show-full-btn';
        a.textContent = 'Clique aqui para ver a consulta completa';
        // ensure accessible
        a.setAttribute('role','button');
        a.setAttribute('aria-label','Ver consulta completa - redireciona para registrar');
        showFullBtnContainer.appendChild(a);
        

      } else {
        // show full
        jsonOutput.textContent = full;
      }
    }

    /* ---------- Main consult function ---------- */
    submitBtn.addEventListener('click', async () => {
      // build payload
      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();
      const whatsapp = document.getElementById('whatsapp').value.trim();
      const tipo = document.getElementById('tipo').value;
      const campo = document.getElementById('campo').value.trim();

      const payload = { nome, email, whatsapp, tipo };
      if (tipo === 'veiculos-dados') payload.placa = campo;
      else payload.chassi = campo;

      const v = validateForm(payload);
      if (v) { toast(v); return; }

      // UI
      loadingEl.classList.remove('hidden');
      resultadoEl.classList.add('hidden');
      actionsRow.classList.add('hidden');
      showFullBtnContainer.innerHTML = '';
      submitBtn.disabled = true;

      try {
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          body: new URLSearchParams(payload)
        });

        // try to parse JSON safely
        let json;
        try { json = await res.json(); } catch { throw new Error('Resposta inválida da API'); }

        loadingEl.classList.add('hidden');

        // Accept both styles: { success: true } or { status: 'success' }
        const ok = (json.success === true) || (json.status === 'success') || (json.status === 'ok') || (json.state === 'success');
        if (!ok) {
          const message = json.message || json.msg || json.error || 'Erro na consulta';
          toast(message);
          submitBtn.disabled = false;
          return;
        }

        // data may be in different nests: json.data.dados OR json.data OR json.data (string)
        const dataBlock = json.data ?? json;
        const dadosField = dataBlock?.dados ?? dataBlock?.dados ?? dataBlock;

        // dadosField may be a string (JSON) or object
        let dadosParsed;
        if (typeof dadosField === 'string') {
          try { dadosParsed = JSON.parse(dadosField); } catch { // maybe json.data is { link:..., dados: "{}" } and dataBlock has other fields
            // try to find any object inside dataBlock
            if (dataBlock && typeof dataBlock === 'object' && Object.keys(dataBlock).length === 2 && dataBlock.link && dataBlock.dados) {
              // fallback: try parsing dataBlock.dados anyway
              try { dadosParsed = JSON.parse(dataBlock.dados); } catch { dadosParsed = dataBlock.dados; }
            } else {
              dadosParsed = dadosField;
            }
          }
        } else {
          dadosParsed = dadosField;
        }

        // format the viewable text
        let pretty = '';
        try {
          if (typeof dadosParsed === 'object') pretty = formatJsonHuman(dadosParsed);
          else pretty = String(dadosParsed);
        } catch {
          pretty = String(dadosParsed);
        }

        // store full text in data-full (so internal actions can still access the complete content if needed)
        jsonOutput.setAttribute('data-full', pretty);
        // update visual (this will truncate if necessary and add the button)
        updateTruncation();

        resultadoEl.classList.remove('hidden');

        // prepare links
        const returnedLink = (dataBlock && dataBlock.link) ? dataBlock.link : (json.link ?? '');
        const linkDownload = returnedLink ? (returnedLink + (returnedLink.includes('?') ? '&' : '?') + 'mode=D') : '';
        const linkView = returnedLink ? (returnedLink + (returnedLink.includes('?') ? '&' : '?') + 'mode=I') : '';
        const linkEmail = returnedLink ? (returnedLink + (returnedLink.includes('?') ? '&' : '?') + 'mode=email') : '';

        // show actions
        actionsRow.classList.remove('hidden');

        // download action: fetch file and download using content-disposition if present
        btnDownload.onclick = async function () {
          const btn = this;
          const prev = btn.innerText;
          btn.disabled = true;
          btn.innerText = 'Gerando...';
          try {
            const r = await fetch(linkDownload);
            if (!r.ok) throw new Error('Erro ao gerar PDF');
            const blob = await r.blob();
            const cd = r.headers.get('content-disposition');
            const filename = filenameFromContentDisposition(cd) || 'consulta.pdf';
            downloadBlob(blob, filename);
          } catch (err) {
            console.error(err);
            toast('Erro ao baixar PDF.');
          }
          btn.disabled = false;
          btn.innerText = prev;
        };

        // view action: open in new tab
        btnView.onclick = async function () {
          const btn = this;
          const prev = btn.innerText;
          btn.disabled = true;
          btn.innerText = 'Abrindo...';
          try {
            const r = await fetch(linkView);
            if (!r.ok) throw new Error('Erro ao visualizar PDF');
            const blob = await r.blob();
            openBlobInNewTab(blob);
          } catch (err) {
            console.error(err);
            toast('Erro ao visualizar.');
          }
          btn.disabled = false;
          btn.innerText = prev;
        };

        // email action: call linkEmail and show result
        btnEmail.onclick = async function () {
          const btn = this;
          const prev = btn.innerText;
          btn.disabled = true;
          btn.innerText = 'Enviando...';
          try {
            const r = await fetch(linkEmail);
            const j = await r.json();
            if ((j.success === true) || (j.status === 'success')) toast('Email enviado!');
            else toast(j.message || 'Erro ao enviar email');
          } catch (err) {
            console.error(err);
            toast('Erro ao enviar email.');
          }
          btn.disabled = false;
          btn.innerText = prev;
        };

        // copy link download
        btnCopyDownload.onclick = () => {
          if (!linkDownload) { toast('Link indisponível'); return; }
          navigator.clipboard.writeText(linkDownload).then(()=>toast('Link copiado!')).catch(()=>toast('Erro ao copiar'));
        };

        // share whatsapp (content) — uses the truncated visible text on purpose (same behavior as before)
        btnShareWhatsapp.onclick = () => {
          const text = encodeURIComponent('Resultado (mascarado):\n' + jsonOutput.textContent);
          const url = 'https://api.whatsapp.com/send?text=' + text;
          window.open(url, '_blank');
        };

      } catch (err) {
        console.error(err);
        loadingEl.classList.add('hidden');
        toast('Erro ao conectar com o servidor.');
      } finally {
        submitBtn.disabled = false;
      }
    });

    /* ---------- Modal / small handlers ---------- */
    function showSignup() { document.getElementById('modal').classList.remove('hidden'); document.getElementById('modal').style.display = 'flex'; }
    function closeModal(){ document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').style.display = 'none'; }
    function submitSignup(){ alert('Fluxo de criação de conta não implementado nesta demo.'); }

    // attach modal functions globally so buttons can call them
    window.showSignup = showSignup;
    window.closeModal = closeModal;
    window.submitSignup = submitSignup;

    // small protection: prevent double clicks
    submitBtn.addEventListener('click', ()=>{ submitBtn.disabled = true; setTimeout(()=>submitBtn.disabled=false, 2500); });

  </script>

</body>
</html>
